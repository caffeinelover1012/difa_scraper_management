{% extends "datasets/base.html" %}
{% load static %}
{% block title %}Scraping Progress{% endblock %}

{% block content %}
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 11000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
    .modal .modal-dialog {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        margin: 0;
    }
    .loader-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .lds-facebook {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
    }
    .lds-facebook div {
        display: inline-block;
        position: absolute;
        left: 8px;
        width: 16px;
        background: #007bff;
        animation: lds-facebook 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
    }
    .lds-facebook div:nth-child(1) {
        left: 8px;
        animation-delay: -0.24s;
    }
    .lds-facebook div:nth-child(2) {
        left: 32px;
        animation-delay: -0.12s;
    }
    .lds-facebook div:nth-child(3) {
        left: 56px;
        animation-delay: 0;
    }
    @keyframes lds-facebook {
        0% {
            top: 8px;
            height: 64px;
        }
        50%, 100% {
            top: 24px;
            height: 32px;
        }
    }
  </style>
<div class="container mt-4">
    <div id="loading-modal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="loader-wrapper">
                    <div class="lds-facebook"><div></div><div></div><div></div></div>
                    <div class="modal-body">
                        <p id="progress" style="height:45px; font-size: medium;" class="text-center progress">Processing... </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Rest of your content -->
</div>

<button id="scrape-all-btn" class="btn btn-primary">Scrape All</button>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('#scrape-all-btn').on('click', function() {
            // Start the scraping process
            $.ajax({
                url: '{% url "scrape_all" %}',
                success: function(response) {
                    $("#loading-modal").show(); // Show the modal
                    checkScrapingProgress(); // Start checking progress
                },
                error: function() {
                    alert('Error starting the scraping process.');
                }
            });
        });
    });

    function checkScrapingProgress() {
        const intervalId = setInterval(function() {
            $.ajax({
                url: '{% url "scrape_progress" %}',
                success: function(data) {
                    // Update progress
                    $("#progress").text("Scraping "+ data.current + " | Progress: " + data.progress + "/" + data.total);

                    if (data.progress === data.total) {
                        clearInterval(intervalId);
                        $("#loading-modal").hide();
                        alert('Scraping completed!');
                    }
                },
                error: function() {
                    clearInterval(intervalId);
                    $("#loading-modal").hide();
                    alert('Error checking scraping progress.');
                }
            });
        }, 1000);
    }
</script>
{% endblock %}
